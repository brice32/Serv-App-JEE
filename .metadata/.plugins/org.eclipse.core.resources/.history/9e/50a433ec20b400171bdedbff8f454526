package contacts.emb.dao.jpa;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Map;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;

import contacts.emb.dao.IDaoCompte;
import contacts.emb.data.Compte;


public class DaoCompte implements IDaoCompte {

	
	// Champs
	
	private Map<Integer, Compte>		mapComptes;
	
	private EntityManager 				em;
	
	// Injecteurs
	
	public void setDonnees( Donnees donnees ) {
		mapComptes = donnees.getMapComptes();
	}

	public void setEntityManager( EntityManager em ) {
		this.em=em;
	}
	
	// Actions
	
	@Override
	public int inserer(Compte compte) {
        if (mapComptes.isEmpty()) {
            compte.setId(1);
        } else {
            compte.setId(Collections.max(mapComptes.keySet()) + 1);
        }
		mapComptes.put( compte.getId(), compte );
		return compte.getId();
	}

	@Override
	public void modifier(Compte compte) {
		mapComptes.replace( compte.getId(), compte );
	}

	@Override
	public void supprimer(int idCompte) {
		Compte compte = retrouver(idCompte);
		em.remove(compte);
	}

	@Override
	public Compte retrouver(int idCompte) {
		return em.find(Compte.class, idCompte);
	}

	@Override
	public List<Compte> listerTout() {
		String jpql="SELECT c FROM Compte c ORDER BY c.pseudo";
		TypedQuery<Compte> query = em.createQuery( jpql , Compte.class);
		return query.getResultList();
	}


	@Override
	public Compte validerAuthentification( String pseudo, String motDePasse )  {

		for ( Compte compte : mapComptes.values() ) {
			if ( compte.getPseudo().equals(pseudo) ) {
				if ( compte.getMotDePasse().equals(motDePasse) ) {
					return compte;
				}
				break;
			}
		}
		return null;
	}


	@Override
	public boolean verifierUnicitePseudo( String pseudo, int idCompte )  {
		
		for ( Compte compte : mapComptes.values() ) {
			if ( compte.getPseudo().equals(pseudo) ) {
				if ( compte.getId() != idCompte  ) {
					return false;
				}
			}
		}
		return true;
	}

	
	// MÃ©thodes auxiliaires
    
    private List<Compte> trierParPseudo( List<Compte> liste ) {
		Collections.sort( liste,
	            (Comparator<Compte>) ( item1, item2) -> {
	                return ( item1.getPseudo().toUpperCase().compareTo( item2.getPseudo().toUpperCase() ) );
			});
    	return liste;
    }
	
	
}
